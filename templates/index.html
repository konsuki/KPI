<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Google Org Chart (Ajax版)</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Google Charts -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        #chart_div {
            width: 100%;
            margin-top: 20px;
        }

        .google-visualization-orgchart-node {
            border: none;
            background: none;
            box-shadow: none;
        }

        .node-content {
            display: inline-block;
            min-width: 160px;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
            background: #fff;
            font: 12px sans-serif;
            text-align: left;
        }

        .node-content.team-a-content,
        .node-content.sub-a-content {
            border-color: #4CAF50;
        }

        .node-content.team-b-content,
        .node-content.sub-b-content {
            border-color: #2196F3;
        }

        .node-content.team-c-content,
        .node-content.sub-c-content {
            border-color: #f44336;
        }

        .node-content.team-d-content,
        .node-content.sub-d-content {
            border-color: #ffeb3b;
        }

        .node-content.team-e-content,
        .node-content.sub-e-content {
            border-color: #ff9800;
        }

        .node-content.ceo-content {
            border-color: #607d8b;
        }

        .node-content.error-content {
            border-color: red !important;
            background: #ffeeee;
            color: red;
        }

        .node-content h4 {
            margin: 0 0 8px;
            font-size: 1.1em;
            color: #333;
            text-align: center;
        }

        .node-content p {
            margin: 4px 0;
            font-size: .9em;
            color: #555;
        }

        .node-content p strong {
            margin-right: 5px;
            color: #000;
        }

        .progress-container {
            margin-top: 8px;
            font-size: .9em;
        }

        .progress-container span {
            display: block;
            margin-bottom: 3px;
            color: #555;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            border-radius: 5px 0 0 5px;
            background: #ff9800;
        }
    </style>

    <script>
        // Google Charts の読み込み
        google.charts.load('current', { packages: ['orgchart'] });

        // Ajax でデータを取得してチャート描画
        function fetchAndDraw() {
            $.ajax({
                url: '/update',
                type: 'GET',
                dataType: 'json',
                success: function (res) {
                    const rowsData = res.chart_data || [];
                    drawChartWithData(rowsData);
                },
                error: function (err) {
                    console.error('データ取得エラー', err);
                }
            });
        }

        // ノードHTMLを組み立て
        function formatNode(cssClass, title, rinen, mokuhyo, kpi, rate) {
            let html = `<div class="node-content ${cssClass || 'default-content'}">` +
                `<h4>${title || ''}</h4>`;
            if (rinen) html += `<p><strong>理念:</strong>${rinen}</p>`;
            if (mokuhyo) html += `<p><strong>目標:</strong>${mokuhyo}</p>`;
            if (kpi) html += `<p><strong>KPI:</strong>${kpi}</p>`;
            const raw = Number.isFinite(rate) ? rate * 100 : 0;
            const pct = Math.floor(raw * 100) / 100;
            html += `<div class="progress-container"><span>達成率:${pct}%</span>` +
                `<div class="progress-bar-bg"><div class="progress-bar" style="width:${pct}%;"></div></div>` +
                `</div></div>`;
            return html;
        }

        // チャート描画
        function drawChartWithData(rowsData) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Name');
            data.addColumn('string', 'Manager');
            data.addColumn('string', 'ToolTip');

            let formatted;
            try {
                formatted = rowsData.map(node => [
                    {
                        v: node.id,
                        f: formatNode(
                            node.cssClass,
                            node.title,
                            node.rinen,
                            node.mokuhyo,
                            node.kpi,
                            node.tasseiRitsu
                        )
                    },
                    node.parent || '',
                    node.tooltip || ''
                ]);

                if (!formatted.length) throw new Error('No data');
            } catch (e) {
                console.error('Error processing data:', e);
                formatted = [[
                    { v: 'error', f: '<div class="node-content error-content">データの表示中にエラーが発生しました</div>' },
                    '',
                    ''
                ]];
            }

            data.addRows(formatted);

            new google.visualization.OrgChart(
                document.getElementById('chart_div')
            ).draw(data, { allowHtml: true, allowCollapse: true });
        }

        // 初回描画 & 定期更新（5秒ごと）
        $(function () {
            google.charts.setOnLoadCallback(function () {
                fetchAndDraw();
                setInterval(fetchAndDraw, 1000000);
            });
        });
    </script>
</head>

<body>
    <div id="chart_div"></div>
</body>

</html>